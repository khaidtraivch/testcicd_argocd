deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh python3 py3-pip
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ğŸ” Checking if send_email.py exists in repo..."
    - ls -lh send_email.py || (echo "âŒ send_email.py not found" && exit 1)

    - echo "ğŸš€ Deploying Docker container..."
    - |
      ssh ubuntu@$EC2_HOST <<EOF
        set -e
        cd ~/flaskbase_ci_deploy
        docker pull $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
        docker compose down || true
        docker compose up -d
        echo "âœ… Docker deployment done"
      EOF

    - echo "ğŸ“¤ Copying send_email.py to EC2..."
    # - scp -v send_email.py ubuntu@$EC2_HOST:/home/ubuntu/ || (echo "âŒ SCP failed" && exit 1)

    - echo "ğŸ Running send_email.py on EC2..."
    - ssh ubuntu@$EC2_HOST "python3 /home/ubuntu/send_email.py"
  only:
    - main
