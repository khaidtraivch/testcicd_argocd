# stages:
#   - sonar_scan

# variables:
#   SONAR_HOST_URL: "http://sonarqube:9000"

# sonar_scan:
#   stage: sonar_scan
#   image: sonarsource/sonar-scanner-cli:latest
#   script:
#     - |
#       sonar-scanner \
#         -Dsonar.projectKey=khainx106_flaskbase_main \
#         -Dsonar.projectName="FlaskBase CI" \
#         -Dsonar.sources=. \
#         -Dsonar.host.url=$SONAR_HOST_URL \
#         -Dsonar.login=$SONAR_TOKEN
#   only:
#     - main
#     - develop
#     - merge_requests

stages:
  - sonar_scan

variables:
  SONAR_HOST_URL: "http://sonarqube:9000"

sonar_scan:
  stage: sonar_scan
  image: sonarsource/sonar-scanner-cli:latest
  script:
    - |
      sonar-scanner \
        -Dsonar.projectKey=khainx106_flaskbase_main \
        -Dsonar.projectName="FlaskBase CI" \
        -Dsonar.sources=. \
        -Dsonar.host.url=$SONAR_HOST_URL \
        -Dsonar.token=$SONAR_TOKEN

    - echo ">>> ƒê·ª£i k·∫øt qu·∫£ Quality Gate..."

    - |
      ce_task_id=$(curl -s -u "$SONAR_TOKEN:" "$SONAR_HOST_URL/api/ce/component?component=khainx106_flaskbase_main" | jq -r '.queue[0].id')
      for i in $(seq 1 30); do
        status=$(curl -s -u "$SONAR_TOKEN:" "$SONAR_HOST_URL/api/ce/task?id=$ce_task_id" | jq -r '.task.status')
        if [ "$status" = "SUCCESS" ]; then
          echo "‚úÖ Analysis done."
          break
        fi
        echo "‚åõ Waiting for analysis ($i)..."
        sleep 5
      done

      analysisId=$(curl -s -u "$SONAR_TOKEN:" "$SONAR_HOST_URL/api/ce/task?id=$ce_task_id" | jq -r '.task.analysisId')
      qg_status=$(curl -s -u "$SONAR_TOKEN:" "$SONAR_HOST_URL/api/qualitygates/project_status?analysisId=$analysisId" | jq -r '.projectStatus.status')

      echo "üìä Quality Gate: $qg_status"

      if [ "$qg_status" != "OK" ]; then
        echo "‚ùå Quality Failed"
        exit 1
      else
        echo "‚úÖ Quality Passed"
      fi
  only:
    - main
    - develop
    - merge_requests




