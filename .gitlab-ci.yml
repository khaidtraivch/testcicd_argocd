stages:
  - sonar_scan
  - build
  - push

variables:
  SONAR_HOST_URL: "http://localhost:9000"
  DOCKER_REGISTRY: "docker.io"
  DOCKER_IMAGE: "khainxphuthai/projectci_ubuntu"
  DOCKER_TAG: "latest"  # Hoặc bạn có thể dùng: $CI_COMMIT_SHORT_SHA

before_script:
  - echo ">>> Cài đặt yêu cầu cho CI job..."

sonar_scan:
  stage: sonar_scan
  image: sonarsource/sonar-scanner-cli:latest
  script:
    - sonar-scanner \
        -Dsonar.projectKey=khainx106-group_flaskbase_ci_deploy_5c3db64c-02ca-4df6-8921-db0e69eb5a0 \
        -Dsonar.host.url=$SONAR_HOST_URL \
        -Dsonar.login=$SONAR_TOKEN
  only:
    - merge_requests
    - main
    - develop

build_image:
  stage: build
  image: docker:latest
  services:
    - docker:20-dind
  script:
    - docker build -t $DOCKER_REGISTRY/$DOCKER_IMAGE:$DOCKER_TAG .
  only:
    - main
    - develop

push_image:
  stage: push
  image: docker:latest
  script:
    - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
    - docker push $DOCKER_REGISTRY/$DOCKER_IMAGE:$DOCKER_TAG
  only:
    - main
